javascript:(function(){var PATTERNS={startMarker:"---SOP---",endMarker:"---EOP---",phrases:["ClaudeCodeに投げるプロンプト","プロンプト（完成形）","以下を実行して","以下のプロンプト","以下の指示"],delimiters:["---"],keywords:["目的：","前提：","完了条件：","対象：","要件：","作業範囲：","受入条件：","方針：","実装仕様："]};function showNotification(m,type){var n=document.createElement('div');n.textContent=m;var bg=type==='success'?'#10a37f':type==='fallback'?'#f59e0b':'#ef4444';n.style.cssText='position:fixed;top:16px;right:16px;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:999999;transition:opacity 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.15);background:'+bg+';color:#fff;';document.body.appendChild(n);setTimeout(function(){n.style.opacity='0';setTimeout(function(){n.remove();},300);},2000);}function htmlToMarkdown(html){var t=document.createElement('div');t.innerHTML=html;t.querySelectorAll('pre').forEach(function(pre){var code=pre.querySelector('code');var txt=code?code.textContent:pre.textContent;var lc=code?code.className.match(/language-(\w+)/):null;var lang=lc?lc[1]:'';pre.outerHTML='\n```'+lang+'\n'+txt+'\n```\n';});for(var i=1;i<=6;i++){t.querySelectorAll('h'+i).forEach(function(h){h.outerHTML='\n'+'#'.repeat(i)+' '+h.textContent+'\n';});}t.querySelectorAll('strong,b').forEach(function(el){el.outerHTML='**'+el.textContent+'**';});t.querySelectorAll('em,i').forEach(function(el){el.outerHTML='*'+el.textContent+'*';});t.querySelectorAll('code').forEach(function(el){el.outerHTML='`'+el.textContent+'`';});t.querySelectorAll('a').forEach(function(el){el.outerHTML='['+el.textContent+']('+el.getAttribute('href')+')';});function processList(list,indent){indent=indent||0;var r='';var items=list.children;var isOrd=list.tagName.toLowerCase()==='ol';var cnt=1;for(var j=0;j<items.length;j++){var item=items[j];if(item.tagName.toLowerCase()==='li'){var pfx='  '.repeat(indent)+(isOrd?(cnt++)+'. ':'- ');var nested=item.querySelector('ul,ol');var txt='';for(var k=0;k<item.childNodes.length;k++){var c=item.childNodes[k];if(c.nodeType===3)txt+=c.textContent.trim();else if(c.tagName&&!['UL','OL'].includes(c.tagName.toUpperCase()))txt+=c.textContent.trim();}r+=pfx+txt+'\n';if(nested)r+=processList(nested,indent+1);}}return r;}t.querySelectorAll('ul,ol').forEach(function(list){if(!list.closest('li'))list.outerHTML='\n'+processList(list,0);});t.querySelectorAll('p').forEach(function(el){el.outerHTML=el.textContent+'\n\n';});t.querySelectorAll('br').forEach(function(el){el.outerHTML='\n';});t.querySelectorAll('div').forEach(function(el){el.outerHTML=el.innerHTML+'\n';});var r=t.textContent||'';r=r.replace(/\n{3,}/g,'\n\n');return r.trim();}function extractPrompt(md){var lines=md.split('\n');var sopIdx=-1,eopIdx=-1;for(var i=0;i<lines.length;i++){var tl=lines[i].trim();if(tl===PATTERNS.startMarker)sopIdx=i;if(tl===PATTERNS.endMarker)eopIdx=i;}if(sopIdx!==-1&&eopIdx!==-1&&sopIdx<eopIdx){var ex=lines.slice(sopIdx+1,eopIdx).join('\n').trim();if(ex)return{text:ex,method:'marker'};}if(sopIdx!==-1){var ex=lines.slice(sopIdx+1).join('\n').trim();if(ex)return{text:ex,method:'marker'};}for(var p=0;p<PATTERNS.phrases.length;p++){var phrase=PATTERNS.phrases[p];for(var i=0;i<lines.length;i++){if(lines[i].indexOf(phrase)!==-1){var ex=lines.slice(i+1).join('\n').trim();if(ex)return{text:ex,method:'fallback'};}}}for(var d=0;d<PATTERNS.delimiters.length;d++){var delim=PATTERNS.delimiters[d];var lastIdx=-1;for(var i=0;i<lines.length;i++){if(lines[i].trim()===delim)lastIdx=i;}if(lastIdx!==-1){var ex=lines.slice(lastIdx+1).join('\n').trim();if(ex)return{text:ex,method:'fallback'};}}for(var k=0;k<PATTERNS.keywords.length;k++){var kw=PATTERNS.keywords[k];for(var i=0;i<lines.length;i++){if(lines[i].indexOf(kw)!==-1){var ex=lines.slice(i).join('\n').trim();if(ex)return{text:ex,method:'fallback'};}}}return null;}try{var resp=document.querySelectorAll('[data-message-author-role="assistant"]');if(!resp||resp.length===0){showNotification('コピーに失敗しました','error');return;}var html=resp[resp.length-1].innerHTML;if(!html||html.trim()===''){showNotification('コピーに失敗しました','error');return;}var md=htmlToMarkdown(html);var result=extractPrompt(md);if(!result){showNotification('プロンプトが見つかりませんでした','error');return;}navigator.clipboard.writeText(result.text).then(function(){showNotification(result.method==='marker'?'プロンプトを抽出しました':'プロンプトを抽出しました（従来方式）',result.method==='marker'?'success':'fallback');}).catch(function(){showNotification('コピーに失敗しました','error');});}catch(e){showNotification('コピーに失敗しました','error');}})();
